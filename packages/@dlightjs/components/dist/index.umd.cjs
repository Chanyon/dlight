(function(p,$){typeof exports=="object"&&typeof module<"u"?$(exports):typeof define=="function"&&define.amd?define(["exports"],$):(p=typeof globalThis<"u"?globalThis:p||self,$(p.Bundle={}))})(this,function(p){"use strict";var ee=Object.defineProperty;var te=(p,$,g)=>$ in p?ee(p,$,{enumerable:!0,configurable:!0,writable:!0,value:g}):p[$]=g;var d=(p,$,g)=>(te(p,typeof $!="symbol"?$+"":$,g),g);function $(o){for(let i of o){if(Array.isArray(i)){$(i);continue}i._$init()}}function g(o,i){for(let e of o){if(Array.isArray(e)){g(e,i);continue}e._$parentNode=i}}function x(o,i){for(let e of o)i(e)&&x(e._$nodes,i)}function y(o,i,e=!0){for(let t of o)[a.HTML,a.Text].includes(t._$nodeType)?(i(t._$el,t),e&&y(t._$nodes,i)):y(t._$nodes,i,e)}function K(o){const i=[];return y(o,(e,t)=>{t._$nodeType===a.HTML&&i.push(e)},!1),i}var a=(o=>(o[o.HTML=0]="HTML",o[o.Text=1]="Text",o[o.Custom=2]="Custom",o[o.For=3]="For",o[o.If=4]="If",o[o.Env=5]="Env",o[o.Expression=6]="Expression",o))(a||{});class M{constructor(i){d(this,"_$nodeType");d(this,"__$el");d(this,"_$parentNode");d(this,"_$nodes",[]);d(this,"_$depObjectIds",[]);this._$nodeType=i}get _$el(){return this.__$el??K(this._$nodes)}set _$el(i){this.__$el=i}_$beforeInitSubNodes(){}_$bindNodes(){g(this._$nodes,this),this._$beforeInitSubNodes(),$(this._$nodes)}_$init(){}render(i){}}function C(o,i,e,t,s,n,r){if(e in o){if(!n){o[e]=t;return}if(console.log(),o[`_$$${e}`]===`_$${i}`){E(s,o,e,t,n);return}if(r&&s[`_$$${n[0]}`]!==void 0){k(s,o,e,t,n);return}V(s,o,e,t,n)}}function E(o,i,e,t,s){const n={};i._$depObjectIds.push(n),i[e]=t(),o._$addDeps(s,n,()=>{i[e]=t(),i._$runDeps(e)})}function k(o,i,e,t,s){const n={};i._$depObjectIds.push(n);for(let r of s){const h=()=>o[r]=i[e];i._$addDeps([e],n,h),i[e]=t(),o._$addDeps(s,n,()=>{i._$deleteDep(e,n),i[e]=t(),i._$addDeps([e],n,h)})}}function V(o,i,e,t,s){const n={};i._$depObjectIds.push(n),i[`_$${e}`]=t(),o._$addDeps(s,n,()=>{i[`_$${e}`]=t(),i._$runDeps(e)})}class B extends M{constructor(){super(a.Custom);d(this,"_$deps",{});d(this,"_$envNodes");d(this,"_$derivedPairs");d(this,"_$children");d(this,"_$tag","");d(this,"Body",()=>[])}_$addAfterset(e){const t=this.Preset;this.Preset=()=>{t(),e()}}_$runDeps(e){if(this._$deps[e]===void 0){console.warn(`${e} is not a dependency in ${this.constructor.name}`);return}for(let t of this._$deps[e].values())t.call(this)}_$addChildren(e){this._$children=e}_$initDecorators(){if(this._$derivedPairs)for(let[e,t]of Object.entries(this._$derivedPairs)){const s=this[e];if(typeof s!="function")return;this[e]=this[e]();let n=this[e];this._$addDeps(t,{},()=>{const r=s();r!==n&&(this[e]=r,n=r,this._$runDeps(e))})}}_$addDeps(e,t,s){for(let n of e)this._$deps[n].set(t,s)}_$deleteDep(e,t){this._$deps[e].delete(t)}_$deleteDeps(e){for(let t in this._$deps)this._$deleteDep(t,e)}Preset(){}Afterset(){}_$bodyRun(){this._$initDecorators(),this.Preset(),this._$nodes=this.Body(),this.Afterset()}_$init(){this._$bodyRun(),this._$bindNodes()}_$addProp(e,t,s,n,r){C(this,"prop",e,t,s,n,r)}render(e){this.willMount(this);for(let t of this._$nodes)t.render(e);this.didMount(this)}willMount(e){}didMount(e){}willUnmount(e){}didUnmount(e){}_$addLifeCycle(e,t){const s=this[t];this[t]=function(n){e.call(this,this),s.call(this,this)}}}class A extends M{constructor(e){super(a.HTML);d(this,"_$envNodes",[]);this._$el=document.createElement(e)}_$init(){this._$bindNodes();for(let e of this._$nodes)e.render(this._$el)}_$addNodes(e){this._$nodes=e}_$addProp(e,t,s,n){let r;if(e[0]==="_"?r=_=>this._$el.style[e.slice(1)]=_:e==="innerText"?r=_=>this._$el.innerText=_:r=_=>this._$el[e]=_,!n){r(t);return}let h=t();r(h);const l=()=>{const _=t();h!==_&&(r(_),h=_)},c={};this._$depObjectIds.push(c),s._$addDeps(n,c,l)}willAppear(e){}didAppear(e){}willDisappear(e){}didDisappear(e){}_$addLifeCycle(e,t){const s=this[t];this[t]=function(n){return s.call(this,n),e.call(this,n)}}render(e){this.willAppear(this._$el),e.appendChild(this._$el),this.didAppear(this._$el)}}function P(o){Z(o),y(o,(i,e)=>{e._$nodeType===a.HTML&&e.willDisappear(i),i.remove(),e._$nodeType===a.HTML&&e.didDisappear(i)}),q(o)}function b(o,i){x(o,e=>{for(let t of e._$depObjectIds)i._$deleteDeps(t);return!0})}function v(o,i,e,t){let s=t??e.childNodes.length;return W(o),y(o,(n,r)=>{const h=e.childNodes[i];[a.HTML].includes(r._$nodeType)&&r.willAppear(n),i===s?e.appendChild(n):e.insertBefore(n,h),[a.HTML].includes(r._$nodeType)&&r.didAppear(n),i++,s++},!1),G(o),[i,s]}function S(o,i){return L(o._$nodes,i)}function F(o){return L(o,void 0)}function L(o,i){let e=0,t=!1;return x(o,s=>t?!1:s===i?(t=!0,!1):[a.Text,a.HTML].includes(s._$nodeType)?(e++,!1):!0),e}function T(o,i){x(o,e=>([a.Custom,a.Expression].includes(e._$nodeType)&&e[i](e),!0))}function W(o){T(o,"willMount")}function G(o){T(o,"didMount")}function Z(o){T(o,"willUnmount")}function q(o){T(o,"didUnmount")}class j extends M{afterUpdateNewNodes(i){}addAfterUpdateNewNodesFunc(i){const e=this.afterUpdateNewNodes;this.afterUpdateNewNodes=function(t){i.call(this,t),e.call(this,t)}}onUpdateNodes(i,e){}addOnUpdateNodesFunc(i){const e=this.onUpdateNodes;this.onUpdateNodes=function(t,s){i.call(this,t,s),e.call(this,t,s)}}_$bindNewNodes(i){this.afterUpdateNewNodes(i),g(i,this),this._$beforeInitSubNodes(),$(i)}}class O extends j{constructor(){super(a.For);d(this,"keys",[]);d(this,"array",[]);d(this,"_$nodess",[]);d(this,"nodeFunc");d(this,"keyFunc");d(this,"arrayFunc");d(this,"dlScope");d(this,"listenDeps");d(this,"_$envNodes",[]);d(this,"duplicatedOrNoKey",!1)}_$getItem(e,t){let s=this.duplicatedOrNoKey?t:this.keys.indexOf(e);return this.array[s]}_$addNodeFunc(e){this.nodeFunc=e}_$addKeyFunc(e){this.keyFunc=e}_$addArrayFunc(e,t,s){this.dlScope=e,this.arrayFunc=t,this.listenDeps=s}_$addNodess(e){this._$nodess=e,this._$nodes=this._$nodess.flat(1)}setArray(){this.array=[...this.arrayFunc()]}setKeys(){if(!this.keyFunc){this.duplicatedOrNoKey=!0;return}const e=[...this.keyFunc()];if(e.length===[...new Set(e)].length){this.keys=e;return}this.keys=[...Array(this.array.length).keys()],console.warn("重复key了"),this.duplicatedOrNoKey=!0}_$init(){if(!this.listenDeps){this._$bindNodes();return}let e=this._$parentNode;for(;e&&e._$nodeType!==a.HTML;)e=e._$parentNode;if(!e)return;const t=this.keyFunc?()=>this.updateWithKey(e):()=>this.updateWithOutKey(e),s={};if(this._$depObjectIds.push(s),this.dlScope._$addDeps(this.listenDeps,s,t),this.setArray(),this.setKeys(),this.duplicatedOrNoKey)for(let n of this.array.keys())this._$nodess.push(this.nodeFunc(null,n,this));else for(let[n,r]of this.keys.entries())this._$nodess.push(this.nodeFunc(r,n,this));this._$nodes=this._$nodess.flat(1),this._$bindNodes()}render(e){for(let t of this._$nodes)t.render(e)}getNewNodes(e,t){const s=this.nodeFunc(e,t,this);return this._$bindNewNodes(s),s}updateWithOutKey(e){const t=e._$el,s=this.array.length;this.setArray();const n=this.array.length;if(s!==n){if(s<n){let r=S(e,this),h=t.childNodes.length;for(let l=0;l<n;l++){if(l<s){r+=F(this._$nodess[l]);continue}const c=this.getNewNodes(null,l);[r,h]=v(c,r,t,h),this._$nodess.push(c)}this._$nodes=this._$nodess.flat(1);return}for(let r=n;r<s;r++)b(this._$nodess[r],this.dlScope),P(this._$nodess[r]);this._$nodess=this._$nodess.slice(0,n),this._$nodes=this._$nodess.flat(1)}}async updateWithKey(e){const t=e._$el,s=S(e,this);let n=this.keys;const r=[...this.array],h=[...this._$nodess],l=[...this._$nodes];this.setArray(),this.setKeys(),this.duplicatedOrNoKey&&(n=[...Array(r.length).keys()]);let c=[];const _=[];for(let[f,w]of n.entries()){if(this.keys.includes(w)){c.push(w),_.push(h[f]);continue}b(h[f],this.dlScope),P(h[f])}n=c;let u=s,N=t.childNodes.length;for(let[f,w]of this.keys.entries()){if(n.includes(w)){u+=F(_[n.indexOf(w)]);continue}const m=this.getNewNodes(w,f);[u,N]=v(m,u,t,N),_.splice(f,0,m),n.splice(f,0,w)}u=s;for(let[f,w]of this.keys.entries()){const m=n.indexOf(w);if(m===f){u+=F(_[f]);continue}const H=_[m],Y=n[m];[u,N]=v(H,u,t,N),_.splice(m,1),n.splice(m,1),_.splice(f+1,0,H),n.splice(f+1,0,Y)}this._$nodess=_,this._$nodes=this._$nodess.flat(1),this.onUpdateNodes(l,this._$nodes)}_$listen(e,t,s,n){const r={};e._$depObjectIds.push(r),e._$addDeps(s,r,()=>{const h=t();if(h===void 0){e._$deleteDeps(r);return}n(h)})}}class U extends j{constructor(){super(a.If);d(this,"conditionPairs",[]);d(this,"condition");d(this,"listenDeps",[]);d(this,"dlScope");d(this,"_$envNodes",[])}_$addCond(e,t,s,n){this.conditionPairs.push({condition:e,node:t}),n&&(this.dlScope||(this.dlScope=s),this.listenDeps.push(...n));let r=[];for(let h of this.conditionPairs)if(h.condition()){this.condition=h.condition.toString(),r=h.node();break}this._$nodes=r}_$init(){var t;let e=this._$parentNode;for(;e&&e._$nodeType!==a.HTML;)e=e._$parentNode;if(e){const s={};this._$depObjectIds.push(s),(t=this.dlScope)==null||t._$addDeps(this.listenDeps,s,()=>this.update(e))}this._$bindNodes()}update(e){const t=this._$nodes,s=this.condition;this._$nodes=[];for(let h of this.conditionPairs)if(h.condition()){this.condition!==h.condition.toString()?(b(t,this.dlScope),P(t),this.condition=h.condition.toString(),this._$nodes=h.node(),this._$bindNewNodes(this._$nodes)):this._$nodes=t;break}if(t.length!==0&&this._$nodes.length===0&&(this.condition="[none]",b(t,this.dlScope),P(t)),s===this.condition)return;const n=S(e,this),r=e._$el;v(this._$nodes,n,r,r.childNodes.length),this.onUpdateNodes(t,this._$nodes)}render(e){for(let t of this._$nodes)t.render(e)}}class z extends M{constructor(i,e,t){if(super(a.Text),!t){this._$el=document.createTextNode(i);return}i=i;let s=i();this._$el=document.createTextNode(s);const n=()=>{const h=i();s!==h&&(this._$el.nodeValue=h,s=h)},r={};this._$depObjectIds.push(r),e._$addDeps(t,r,n)}render(i){i.appendChild(this._$el)}}class I extends j{constructor(e,t,s){super(a.Expression);d(this,"nodeOrFunc");d(this,"listenDeps");d(this,"dlScope");d(this,"propFuncs",[]);d(this,"propScope",()=>!0);d(this,"deepLoopEl",!1);if(!s){this._$nodes=this.formatNodes(e);return}this.nodeOrFunc=e,this.listenDeps=s,this.dlScope=t,this._$nodes=this.formatNodes(this.nodeOrFunc())}_$onUpdateNodes(e){x(this._$nodes,t=>([a.If,a.For,a.Expression].includes(t._$nodeType)&&t.addOnUpdateNodesFunc(e),!0))}_$addProp(e,t,s,n){const r=this.propScope,h=this.deepLoopEl,l=c=>{const _=c._$el;r(_,c)&&(e[0]==="_"&&(c._$el.style[e.slice(1)]??"").trim()!==""||e[0]!=="_"&&c._$el[e]!==void 0||c._$addProp(e,t,s,n))};this.propFuncs.push(()=>{for(let c of this._$nodes)switch(c._$nodeType){case a.HTML:l(c),h&&y(c._$nodes,(_,u)=>{u._$nodeType===a.HTML&&l(u)},!0);break;case a.For:case a.If:case a.Expression:c.addAfterUpdateNewNodesFunc(_=>{y(_,(u,N)=>{N._$nodeType===a.HTML&&l(N)},h)});default:y(c._$nodes,(_,u)=>{u._$nodeType===a.HTML&&l(u)},h)}})}formatNodes(e){return Array.isArray(e)||(e=[e]),e=e.flat(1),e=e.filter(t=>t!=null).map(t=>t._$nodeType!==void 0?t:new z(t)),e}_$init(){if(this.listenDeps===void 0){this._$bindNodes();for(let s of this.propFuncs)s();return}let e=this._$parentNode;for(;e&&e._$nodeType!==a.HTML;)e=e._$parentNode;if(!e)return;const t={};this._$depObjectIds.push(t),this.dlScope._$addDeps(this.listenDeps,t,()=>this.update(e)),this._$bindNodes();for(let s of this.propFuncs){s();const n={};this._$depObjectIds.push(n),this.dlScope._$addDeps(this.listenDeps,n,s)}}render(e){this.willMount(this);for(let t of this._$nodes)t.render(e);this.didMount(this)}update(e){const t=this._$nodes;b(this._$nodes,this.dlScope),P(this._$nodes),this._$nodes=this.formatNodes(this.nodeOrFunc()),this._$bindNewNodes(this._$nodes);const s=e._$el,n=S(e,this);v(this._$nodes,n,s,s.childNodes.length),this.onUpdateNodes(t,this._$nodes)}willMount(e){}didMount(e){}willUnmount(e){}didUnmount(e){}_$addLifeCycle(e,t){const s=this[t];this[t]=function(n){e.call(this,this),s.call(this,this)}}}const D=B;class J extends D{constructor(){super(...arguments);d(this,"_$tag","Spacer");d(this,"Body",()=>[new A("div")])}}class Q extends D{constructor(){super(...arguments);d(this,"_$derivedPairs",{margin:["alignment"]});d(this,"_$deps",{spacing:new Map,alignment:new Map,width:new Map,height:new Map,margin:new Map});d(this,"_$tag","HStack");d(this,"_$$spacing","_$prop");d(this,"spacing",10);d(this,"_$$alignment","_$prop");d(this,"alignment","top");d(this,"_$$width","_$prop");d(this,"width","100%");d(this,"_$$height","_$prop");d(this,"height","max-content");d(this,"margin",()=>function(){switch(this.alignment){case"top":return"0 0 auto 0";case"bottom":return"auto 0 0 0";case"center":return"auto 0";default:return"auto"}}.call(this));d(this,"Body",()=>{const e=new A("div");return e._$addProp("_height",()=>this.height,this,["height"]),e._$addProp("_width",()=>this.width,this,["width"]),e._$addProp("_columnGap",()=>`${this.spacing}px`,this,["spacing"]),e._$addProp("_display","flex"),e._$addProp("_flexDirection","row"),e._$addNodes((()=>{const t=new O;return t._$addNodess(Array.from(this._$children).map(s=>(()=>{const n=new U;return n._$addCond(()=>s._$tag==="Spacer",()=>{const r=new I(s());return r._$addProp("_flexGrow",1),[r]}),n._$addCond(()=>!0,()=>{const r=new I(s());return r._$addProp("_flexShrink",0),r._$addProp("_margin",()=>this.margin,this,["margin"],!0),[r]}),[n]})())),[t]})()),[e]})}}class R extends D{constructor(){super(...arguments);d(this,"_$derivedPairs",{margin:["alignment"]});d(this,"_$deps",{spacing:new Map,alignment:new Map,width:new Map,height:new Map,margin:new Map});d(this,"_$tag","VStack");d(this,"_$$spacing","_$prop");d(this,"spacing",10);d(this,"_$$alignment","_$prop");d(this,"alignment","top");d(this,"_$$width","_$prop");d(this,"width","max-content");d(this,"_$$height","_$prop");d(this,"height","100%");d(this,"margin",()=>function(){switch(this.alignment){case"top":return"0 auto 0 0";case"bottom":return"0 0 0 auto";case"center":return"0 auto";default:return"auto"}}.call(this));d(this,"Body",()=>{const e=new A("div");return e._$addProp("_height",()=>this.height,this,["height"]),e._$addProp("_width",()=>this.width,this,["width"]),e._$addProp("_columnGap",()=>`${this.spacing}px`,this,["spacing"]),e._$addProp("_display","flex"),e._$addProp("_flexDirection","column"),e._$addNodes((()=>{const t=new O;return t._$addNodess(Array.from(this._$children).map(s=>(()=>{const n=new U;return n._$addCond(()=>s._$tag==="Spacer",()=>{const r=new I(s());return r._$addProp("_flexGrow",1),[r]}),n._$addCond(()=>!0,()=>{const r=new I(s());return r._$addProp("_flexShrink",0),r._$addProp("_margin",()=>this.margin,this,["margin"],!0),[r]}),[n]})())),[t]})()),[e]})}}class X extends D{constructor(){super(...arguments);d(this,"_$deps",{hAlignment:new Map,vAlignment:new Map,width:new Map,height:new Map});d(this,"_$tag","ZStack");d(this,"_$$hAlignment","_$prop");d(this,"hAlignment","center");d(this,"_$$vAlignment","_$prop");d(this,"vAlignment","center");d(this,"_$$width","_$prop");d(this,"width","max-content");d(this,"_$$height","_$prop");d(this,"height","max-content");d(this,"Body",()=>{const e=new A("div");return e._$addProp("_height",()=>this.height,this,["height"]),e._$addProp("_width",()=>this.width,this,["width"]),e._$addProp("_columnGap",`${this.spacing}px`),e._$addProp("_display","grid"),e._$addProp("_alignItems",()=>({top:"flex-start",center:"center",bottom:"flex-end"})[this.vAlignment],this,["vAlignment"]),e._$addProp("_justifyItems",()=>({leading:"left",center:"center",tailing:"right"})[this.hAlignment],this,["hAlignment"]),e._$addNodes((()=>{const t=new O;return t._$addNodess(Array.from(this._$children).map(s=>(()=>{const n=new I(s());return n._$addProp("_position","relative"),n._$addProp("_gridArea","1 / 1/ 1 / 1"),[n]})())),[t]})()),[e]})}}p.HStack=Q,p.Spacer=J,p.VStack=R,p.ZStack=X,Object.defineProperty(p,Symbol.toStringTag,{value:"Module"})});

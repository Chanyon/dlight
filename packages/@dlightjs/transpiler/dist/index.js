"use strict";var le=Object.create;var I=Object.defineProperty;var pe=Object.getOwnPropertyDescriptor;var ce=Object.getOwnPropertyNames;var ue=Object.getPrototypeOf,fe=Object.prototype.hasOwnProperty;var ge=(t,e)=>{for(var r in e)I(t,r,{get:e[r],enumerable:!0})},M=(t,e,r,n)=>{if(e&&typeof e=="object"||typeof e=="function")for(let s of ce(e))!fe.call(t,s)&&s!==r&&I(t,s,{get:()=>e[s],enumerable:!(n=pe(e,s))||n.enumerable});return t};var _=(t,e,r)=>(r=t!=null?le(ue(t)):{},M(e||!t||!t.__esModule?I(r,"default",{value:t,enumerable:!0}):r,t)),me=t=>M(I({},"__esModule",{value:!0}),t);var Ae={};ge(Ae,{parseDlightFile:()=>de});module.exports=me(Ae);var l=_(require("@babel/types"));var B=_(require("@babel/core")),V=_(require("@babel/generator")),d={traverse:B.traverse,generate:t=>(0,V.default)(t).code,parse:t=>B.parse(t,{plugins:[["@babel/plugin-syntax-typescript",{isTSX:!0}],"@babel/plugin-syntax-jsx","@babel/plugin-syntax-do-expressions",["@babel/plugin-proposal-decorators",{legacy:!0}]]})};function j(t,e,r,n){n.body.includes(r)||n.body.unshift(r),r.value.properties.push(l.objectProperty(l.identifier(t),l.arrayExpression(e.map(s=>l.stringLiteral(s)))))}function D(t,e,r){r.body.includes(e)||r.body.unshift(e),!e.value.properties.map(n=>n.key.name).includes(t)&&e.value.properties.push(l.objectProperty(l.identifier(t),l.newExpression(l.identifier("Map"),[])))}function T(t,e){let r=!1,n=t.parentPath;for(;n&&n.node!==e;){if(l.isArrowFunctionExpression(n.node)){r=!0;break}n=n.parentPath}return r}function ye(t){let e=t.parentPath.node;return l.isAssignmentExpression(e)&&e.left===t.node}function $e(t,e){let r=t.node,n=!1,s=t.parentPath;for(;s&&s.node!==e;){if(l.isAssignmentExpression(s.node)){let o=s.node.left,i=r.type===o.type,a=r.property.name===o.property.name;n=i&&a}s=s.parentPath}return n}function F(t,e){return!T(t,e)&&!ye(t)&&!$e(t,e)}function N(t){return d.parse(t).program.body[0].body}function O(t,e,r){return[l.classMethod("get",l.identifier(t),[],e),l.classMethod("set",l.identifier(t),[l.identifier("value")],r)]}function W(t){let e=t.value;t.value={type:"ArrowFunctionExpression",params:[],body:e}}var f=_(require("@babel/types"));function H(t){let e=t.tag,r=/html\((.+)\)/;return r.test(t.tag)?(t.tag=t.tag.replace(r,"$1"),!0):/^[a-z][a-z0-9]*$/.test(e)?(t.tag=`"${t.tag}"`,!0):!1}function z(t){return`${t}
`}function q(t){return"["+t.map((e,r)=>`_$node${r}`).join(", ")+"]"}var g=class{value="";add(e){this.value+=z(e)}shift(e){this.value=z(e)+this.value}addBody(e){this.value+=e.value}};var m=_(require("@babel/types"));function $(t){return"["+t.map(e=>'"'+e+'"').join(", ")+"]"}function U(){return Math.random().toString(20).slice(2,8)}function Z(t,e,r=[]){let n=d.parse(`(${t})`),s=[];return d.traverse(n,{MemberExpression(o){e.includes(o.node.property.name)&&F(o)&&s.push(o.node.property.name)}}),s=[...new Set([...s,...r])],s}function K(t,e,r=[]){let n=d.parse(`(${t})`),s=[];return d.traverse(n,{Identifier(o){for(let{ids:i,propNames:a}of e)i.includes(o.node.name)&&(T(o)||s.push(...a))}}),s=[...new Set([...s,...r])],s}function R(t){return t.match(/[_$a-zA-Z][_$a-zA-Z0-9]*/g)??[]}function A(t){let e=d.parse(`(${t})`);return m.isMemberExpression(e.program.body[0].expression)}function G(t,e){let r=[],n=d.parse(e);d.traverse(n,{Identifier(o){r.push(o.node.name)}});let s=d.parse(`function tempFunc() {${t}}`);return d.traverse(s,{Identifier(o){if(r.includes(o.node.name)&&!m.isMemberExpression(o.parentPath.node)){let i=m.memberExpression(m.identifier("_$valuedItem"),m.identifier(o.node.name));o.replaceWith(i),o.skip()}}}),d.generate(s.program.body[0].body).trim().replace(/(^\{)|(\}$)/g,"")}function Q(t){let e=d.parse(`let _ = ${t}`).program.body[0].declarations[0].init;return!!(m.isArrowFunctionExpression(e)||m.isFunctionExpression(e))}var E=class{depChain;subViews;idDepsArr=[];constructor(e,r){this.depChain=e,this.subViews=r}generate(e){let r=new g;for(let[n,s]of e.entries())r.addBody(this.resolveParserNode(s,n));return r.add(`return ${q(e)}`),r.value}geneDeps(e){return[...new Set([...Z(e,this.depChain),...K(e,this.idDepsArr)])]}resolveParserNode(e,r){return this.subViews.includes(e.tag)?this.resolveSubView(e,r):e.tag==="env"?this.resolveEnv(e,r):e.tag==="_"?this.resolveExpression(e,r):e.tag==="if"?this.resolveIf(e,r):e.tag==="for"?this.resolveFor(e,r):e.tag==="_$text"?this.resolveText(e,r):H(e)?this.resolveHTML(e,r):this.resolveCustom(e,r)}resolveIf(e,r){let n=new g,s=`_$node${r}`;n.add(`const ${s} = new _$.IfNode()`);for(let o of e.attr.conditions){n.add(`${s}._$addCond(() => ${o.condition}, () => {`),n.add(this.generate(o.parserNodes));let i=this.geneDeps(o.condition);if(i.length>0){n.add(`}, this, ${$(i)})`);continue}n.add("})")}return n}resolveFor(e,r){let n=new g,s=e.attr.key,o=e.attr.item,i=e.attr.array,a=`_$node${r}`;n.add(`const ${a} = new _$.ForNode()`);let u=this.geneDeps(i);if(u.length>0){n.add(`${a}._$addNodeFunc((_$key, _$idx, node_for) => {`);let P=o.match(/[_$a-zA-Z][_$a-zA-Z0-9]*/g)??[];n.add(`const ${o} = node_for._$getItem(_$key, _$idx)`),n.add("const _$valuedItem = {}");for(let b of P)n.add(`_$valuedItem.${b} = ${b}`);n.add(`node_for._$listen(this, ()=>node_for._$getItem(_$key, _$idx),             ${$(u)}, (_$item) => {`),n.add(`const ${o} = _$item`);for(let b of P)n.add(`_$valuedItem.${b} = ${b}`);n.add("})");let y=new E(this.depChain,this.subViews);y.idDepsArr=[{ids:R(o),propNames:u}];let p=y.generate(e.children);p=G(p,o),n.add(p),n.add("})"),s&&(n.add(`${a}._$addKeyFunc(() => {`),n.add("const keys = []"),n.add(`for (let ${o} of ${i}) {`),n.add(`keys.push(${s})`),n.add("}"),n.add("return keys"),n.add("})")),n.add(`${a}._$addArrayFunc(this, () => (${i}), ${$(u)})`)}else n.add(`${a}._$addNodess(Array.from(${i}).map((${o}) => (() => {`),n.add(this.generate(e.children)),n.add("})()))");return n}resolveText(e,r){let n=new g,s=e.attr._$content,o=this.geneDeps(`${s}`),i=`_$node${r}`;return o.length>0?n.add(`const ${i} = new _$.TextNode(() => ${s}, this, ${$(o)})`):n.add(`const ${i} = new _$.TextNode(${s}, )`),n}resolveHTML(e,r){let n=new g,s=`_$node${r}`;n.add(`const ${s} = new _$.HtmlNode(${e.tag}, )`);for(let{key:o,value:i,nodes:a}of e.attr.props){if(i=this.parsePropNodes(i,a),o==="element"){n.add(`${i} = ${s}._$el`);continue}if(["willAppear","didAppear","willDisappear","didDisappear"].includes(o)){n.add(`${s}._$addLifeCycle(${i}, "${o}")`);continue}o==="_$content"&&(o="innerText");let u=this.geneDeps(i);if(u.length>0){n.add(`${s}._$addProp("${o}", () => (${i}), this, ${$(u)})`);continue}n.add(`${s}._$addProp("${o}", ${i})`)}return e.children.length>0&&(n.add(`${s}._$addNodes((() => {`),n.add(this.generate(e.children)),n.add("})())")),n}resolveCustom(e,r){let n=new g,s=`_$node${r}`;n.add(`const ${s} = new (${e.tag})()`);for(let{key:o,value:i,nodes:a}of e.attr.props){if(i=this.parsePropNodes(i,a),o==="element"){Q(i)?n.add(`${s}._$addAfterset(() => (${i})(${s}._$el))`):n.add(`${s}._$addAfterset(() => ${i} = ${s}._$el)`);continue}if(["willMount","didMount","willUnmount","didUnmount"].includes(o)){n.add(`${s}._$addLifeCycle(${i}, "${o}")`);continue}let u=this.geneDeps(i);if(u.length>0){n.add(`${s}._$addProp("${o}", () => (${i}), this, ${$(u)}, ${A(i)})`);continue}n.add(`${s}._$addProp("${o}", ${i})`)}if(e.children.length>0){n.add(`${s}._$addChildren([`);for(let o of e.children)n.add("() => {"),n.addBody(this.resolveParserNode(o,0)),n.add("return _$node0"),n.add("},");n.add("])")}return n}resolveSubView(e,r){let n=new g;return n.add(`const _$node${r} = ${e.tag}()`),n}resolveEnv(e,r){let n=new g,s=`_$node${r}`;n.add(`const ${s} = new _$.EnvNode()`),e.children.length>0&&(n.add(`${s}._$addNodes((() => {`),n.add(this.generate(e.children)),n.add("})())"));for(let{key:o,value:i,nodes:a}of e.attr.props){i=this.parsePropNodes(i,a);let u=this.geneDeps(i);if(u.length>0){n.add(`${s}._$addProp("${o}", () => (${i}), this, ${$(u)}, ${A(i)})`);continue}n.add(`${s}._$addProp("${o}", ${i})`)}return n}resolveExpression(e,r){let n=new g,s=`_$node${r}`;for(let{key:o,value:i,nodes:a}of e.attr.props){if(i=this.parsePropNodes(i,a),o==="_$content"){let P=this.geneDeps(i);P.length>0?n.add(`const ${s} = new _$.ExpressionNode(() => ${i}, this, ${$(P)})`):n.add(`const ${s} = new _$.ExpressionNode(${i}, )`);continue}if(o==="onUpdateNodes"){n.add(`${s}._$onUpdateNodes(${i})`);continue}let u=this.geneDeps(i);if(u.length>0){n.add(`${s}._$addProp("${o}", () => (${i}), this, ${$(u)}, ${A(i)})`);continue}n.add(`${s}._$addProp("${o}", ${i})`)}return n}parsePropNodes(e,r){for(let[n,s]of Object.entries(r)){let o=new g;o.add("((()=>{"),o.add(this.generate(s)),o.add("})())"),e=e.replace('"'+n+'"',o.value)}return e}};function X(t,e,r){return new E(e,r).generate(t)}var c=_(require("@babel/types"));function he(){return Math.random().toString(32).slice(2)}function Y(t,e){if(!e)return{key:t,value:!0,nodes:{}};let r=d.parse(d.generate(e)),n={};return d.traverse(r,{DoExpression(s){let o=s.node,i=he();n[i]=ne(o.body.body),s.replaceWith(c.stringLiteral(i))}}),{key:t,value:d.generate(r).replace(/;$/,""),nodes:n}}function xe(t){let e={tag:"",attr:{props:[]},children:[]},r=t;for(;r&&r.callee&&r.callee.loc?.start.line!==r.callee.loc?.end.line;){let n=r.arguments[0],s=r.callee.property.name;e.attr.props.push(Y(s,n)),r=r.callee.object}return r.arguments.length>0&&e.attr.props.push(Y("_$content",r.arguments[0])),e.tag=d.generate(r.callee),e}function be(t){return{tag:"_$text",attr:{_$content:d.generate(t)},children:[]}}function _e(t){let e=ee(t.tag);Array.isArray(e)||(e=[e]);let r={tag:"_$text",attr:{_$content:d.generate(t.quasi)},children:[]};return[...e,r]}function ee(t){return c.isCallExpression(t)?xe(t):c.isStringLiteral(t)||c.isTemplateLiteral(t)?be(t):c.isTaggedTemplateExpression(t)?_e(t):{}}function ve(t){let e=d.generate(t.left.declarations[0]),r=d.generate(t.right),n={tag:"for",attr:{item:e,array:r},children:[]},s=t.body.body;return c.isArrayExpression(s[0].expression)&&(n.attr.key=d.generate(s[0].expression.elements[0]),s=s.slice(1)),n.children=C(s),n}function Pe(t){return{tag:"if",attr:{conditions:te(t)},children:[]}}function te(t){let e=[],r=d.generate(t.test),n=C(t.consequent.body);return e.push({condition:r,parserNodes:n}),c.isIfStatement(t.alternate)?e.push(...te(t.alternate)):t.alternate&&e.push({condition:!0,parserNodes:C(t.alternate.body)}),e}function C(t){let e=[];for(let r of t)if(c.isExpressionStatement(r)){let n=ee(r.expression);Array.isArray(n)||(n=[n]),e.push(...n)}else c.isBlockStatement(r)?e[e.length-1].children=C(r.body):c.isForOfStatement(r)?e.push(ve(r)):c.isIfStatement(r)&&e.push(Pe(r));return e}function ne(t){return C(t)}var re=ne;var h=_(require("@babel/types"));function se(t,e){if(!e)return{key:t,value:!0,nodes:{}};let r=d.parse(d.generate(e)),n={};d.traverse(r,{JSXElement(o){let i=U();n[i]=v([o.node]),o.replaceWith(h.stringLiteral(i))}});let s=d.generate(e);return h.isJSXExpressionContainer(e)&&(s=s.replace(/^\{(.+)\}$/,"$1")),s.trim()===""&&(s='""'),{key:t,value:s,nodes:n}}function Ne(t){let e=t.openingElement.name.name,r=[];for(let n of t.openingElement.attributes)n=n,r.push(se(n.name.name,n.value));return{tag:e,attr:{props:r},children:v(t.children)}}function we(t){let e=t.value.trim();return e===""?void 0:{tag:"_$text",attr:{_$content:`"${e}"`},children:[]}}function k(t,e){let r=t.openingElement.attributes.find(o=>o.name.name===e);if(!r)return r;let n="",s=r.value;return n=h.isJSXExpressionContainer(s)?d.generate(s.expression):d.generate(s),n}function Se(t){return{tag:"if",attr:{conditions:[{condition:k(t,"cond"),parserNodes:v(t.children)}]},children:[]}}function Ee(t,e){e.attr.conditions.push({condition:k(t,"cond"),parserNodes:v(t.children)})}function Ce(t,e){e.attr.conditions.push({condition:"true",parserNodes:v(t.children)})}function ke(t){return{tag:"for",attr:{item:k(t,"let"),array:k(t,"of"),key:k(t,"key")},children:v(t.children)}}function Ie(t){return{tag:"_",attr:{props:[se("_$content",t)]},children:[]}}function v(t){let e=[];for(let r of t){if(h.isJSXText(r)){let s=we(r);s&&e.push(s);continue}if(h.isJSXExpressionContainer(r)){e.push(Ie(r));continue}if(h.isJSXFragment(r)){e.push(...v(r.children));continue}let n=r.openingElement.name.name;if(n==="if"){e.push(Se(r));continue}if(n==="else-if"){Ee(r,e[e.length-1]);continue}if(n==="else"){Ce(r,e[e.length-1]);continue}if(n==="for"){e.push(ke(r));continue}e.push(Ne(r))}return e}function Be(t){return v([t])}var oe=Be;var w=_(require("@babel/types"));function ie(t,e){let r=t.key.name;t.key.name=`_$$${r}`;let n=e.body.indexOf(t),s=N(`
    function ${r}() {
        return this._$$${r}
    }`),o=N(`
    function ${r}(value) {
        if (this._$$${r} === value) return
        this._$$${r} = value
        this._$runDeps("${r}")
    }`),[i,a]=O(r,s,o);e.body.splice(n+1,0,i,a)}function ae(t,e,r){let n=t.key.name,s=e.body.indexOf(t),o=r.toLowerCase(),i=w.classProperty(w.identifier(`_$$${n}`),w.stringLiteral(`_$${o}`));e.body.splice(s,0,i)}function De(t,e,r){let n=X(re(t.body.body),e,r);t.body=N(`function tmp() { ${n} }`)}function Fe(t,e,r){let n=X(oe(t.value),e,r);t.value=f.arrowFunctionExpression([],N(`function tmp() { ${n} }`))}function L(t,e,r){let n=r==="jsd"?De:Fe,s,o=[];for(let a of t.body)a.decorators?.find(u=>f.isIdentifier(u.expression)&&u.expression.name==="View")?(a.decorators=void 0,o.push(a)):a.key.name==="Body"&&(s=a);let i=o.map(a=>"this."+a.key.name);for(let a of o)n(a,e,i);n(s,e,i)}function de(t,e){let r=d.parse(t),n=null,s=null,o=null,i=null,a=[];return d.traverse(r,{ClassDeclaration(y){let p=y.node;if(f.isIdentifier(p.superClass,{name:"View"})){n=p,s=n.body,s.body.unshift(f.classProperty(f.identifier("_$tag"),f.stringLiteral(n.id.name))),i=f.classProperty(f.identifier("_$derivedPairs"),f.objectExpression([])),o=f.classProperty(f.identifier("_$deps"),f.objectExpression([])),a=[];return}},ClassMethod(y){!n||s.body.indexOf(y.node)===s.body.length-1&&L(s,a,e)},ClassProperty(y){if(!n)return;let p=y.node,b=s.body.indexOf(y.node)===s.body.length-1;if(p.decorators?.find(x=>f.isIdentifier(x.expression)&&x.expression.name==="View")||p.key.name==="Body"){b&&L(s,a,e);return}let S=[];if(y.scope.traverse(p,{MemberExpression(x){a.includes(x.node.property.name)&&F(x,n)&&S.push(x.node.property.name)}}),S=[...new Set(S)],S.length>0&&(j(p.key.name,S,i,s),D(p.key.name,o,s),W(p),a.push(p.key.name)),p.decorators){for(let x of p.decorators){let J=x.expression.name??x.expression.callee.name;if(["EnvState","PropState","State"].includes(J)){a.push(p.key.name),D(p.key.name,o,s),ie(p,s);break}if(["Prop","Env"].includes(J)){a.push(p.key.name),D(p.key.name,o,s),ae(p,s,J);break}}p.decorators=null}b&&L(s,a,e)}}),`import * as _$ from '@dlightjs/dlight';
`+d.generate(r)}0&&(module.exports={parseDlightFile});

"use strict";var le=Object.create;var I=Object.defineProperty;var pe=Object.getOwnPropertyDescriptor;var ce=Object.getOwnPropertyNames;var ue=Object.getPrototypeOf,fe=Object.prototype.hasOwnProperty;var ge=(n,e)=>{for(var r in e)I(n,r,{get:e[r],enumerable:!0})},V=(n,e,r,t)=>{if(e&&typeof e=="object"||typeof e=="function")for(let s of ce(e))!fe.call(n,s)&&s!==r&&I(n,s,{get:()=>e[s],enumerable:!(t=pe(e,s))||t.enumerable});return n};var _=(n,e,r)=>(r=n!=null?le(ue(n)):{},V(e||!n||!n.__esModule?I(r,"default",{value:n,enumerable:!0}):r,n)),me=n=>V(I({},"__esModule",{value:!0}),n);var Je={};ge(Je,{parseDlightFile:()=>de});module.exports=me(Je);var f=_(require("@babel/types"));var D=_(require("@babel/core")),W=_(require("@babel/generator")),d={traverse:D.traverse,generate:n=>(0,W.default)(n).code,parse:n=>D.parse(n,{plugins:[["@babel/plugin-syntax-typescript",{isTSX:!0}],"@babel/plugin-syntax-jsx","@babel/plugin-syntax-do-expressions",["@babel/plugin-proposal-decorators",{legacy:!0}]]})};function O(n,e,r,t){t.body.includes(r)||t.body.unshift(r),r.value.properties.push(f.objectProperty(f.identifier(n),f.arrayExpression(e.map(s=>f.stringLiteral(s)))))}function A(n,e,r){r.body.includes(e)||r.body.unshift(e),!e.value.properties.map(t=>t.key.name).includes(n)&&e.value.properties.push(f.objectProperty(f.identifier(n),f.newExpression(f.identifier("Map"),[])))}function M(n,e){let r=!1,t=n.parentPath;for(;t&&t.node!==e;){if(f.isArrowFunctionExpression(t.node)){r=!0;break}t=t.parentPath}return r}function ye(n){let e=n.parentPath.node;return f.isAssignmentExpression(e)&&e.left===n.node}function $e(n,e){let r=n.node,t=!1,s=n.parentPath;for(;s&&s.node!==e;){if(f.isAssignmentExpression(s.node)){let i=s.node.left,o=r.type===i.type,a=r.property.name===i.property.name;t=o&&a}s=s.parentPath}return t}function B(n,e){return!M(n,e)&&!ye(n)&&!$e(n,e)}function E(n){return d.parse(n).program.body[0].body}function z(n,e,r){return[f.classMethod("get",f.identifier(n),[],e),f.classMethod("set",f.identifier(n),[f.identifier("value")],r)]}function H(n){let e=n.value;n.value={type:"ArrowFunctionExpression",params:[],body:e}}var l=_(require("@babel/types"));function U(n){let e=n.tag,r=/html\((.+)\)/;return r.test(n.tag)?(n.tag=n.tag.replace(r,"$1"),!0):/^[a-z][a-z0-9]*$/.test(e)?(n.tag=`"${n.tag}"`,!0):!1}function q(n){return`${n}
`}function Z(n){return"["+n.map((e,r)=>e.attr.isSubView?`..._$node${r}`:`_$node${r}`).join(", ")+"]"}var y=class{value="";add(e){this.value+=q(e)}shift(e){this.value=q(e)+this.value}addBody(e){this.value+=e.value}};var $=_(require("@babel/types"));function b(n){return"["+n.map(e=>e.startsWith("...")?e:'"'+e+'"').join(", ")+"]"}function N(){return Math.random().toString(20).slice(2,8)}function K(n,e,r=[]){let t=d.parse(`(${n})`),s=[];return d.traverse(t,{MemberExpression(i){e.includes(i.node.property.name)&&B(i)&&s.push(i.node.property.name)}}),s=[...new Set([...s,...r])],s}function R(n,e,r=[]){let t=d.parse(`(${n})`),s=[];return d.traverse(t,{Identifier(i){for(let{ids:o,propNames:a}of e)o.includes(i.node.name)&&(M(i)||s.push(...a))}}),s=[...new Set([...s,...r])],s}function G(n){return n.match(/[_$a-zA-Z][_$a-zA-Z0-9]*/g)??[]}function F(n){let e=d.parse(`(${n})`);return $.isMemberExpression(e.program.body[0].expression)}function Q(n,e,r){let t=[],s=d.parse(e);d.traverse(s,{Identifier(o){t.push(o.node.name)}});let i=d.parse(`function tempFunc() {${n}}`);return d.traverse(i,{Identifier(o){if(t.includes(o.node.name)&&!$.isMemberExpression(o.parentPath.node)){let a=$.memberExpression($.identifier(r),$.identifier(o.node.name));o.replaceWith(a),o.skip()}}}),d.generate(i.program.body[0].body).trim().replace(/(^\{)|(\}$)/g,"")}function Y(n){let e=d.parse(`let _ = ${n}`).program.body[0].declarations[0].init;return!!($.isArrowFunctionExpression(e)||$.isFunctionExpression(e))}var w=class{depChain;subViews;idDepsArr=[];constructor(e,r,t=[]){this.depChain=e,this.subViews=r,this.idDepsArr=t}generate(e){let r=new y;for(let[t,s]of e.entries())r.addBody(this.resolveParserNode(s,t));return r.add(`return ${Z(e)}`),r.value}geneDeps(e){return[...new Set([...K(e,this.depChain),...R(e,this.idDepsArr)])]}resolveParserNode(e,r){return this.subViews.includes(e.tag)?this.resolveSubView(e,r):e.tag==="env"?this.resolveEnv(e,r):e.tag==="_"?this.resolveExpression(e,r):e.tag==="if"?this.resolveIf(e,r):e.tag==="for"?this.resolveFor(e,r):e.tag==="_$text"?this.resolveText(e,r):U(e)?this.resolveHTML(e,r):this.resolveCustom(e,r)}resolveIf(e,r){let t=new y,s=`_$node${r}`;t.add(`const ${s} = new _$.IfNode()`);for(let i of e.attr.conditions){t.add(`${s}._$addCond(() => ${i.condition}, () => {`),t.add(this.generate(i.parserNodes));let o=this.geneDeps(i.condition);if(o.length>0){t.add(`}, this, ${b(o)})`);continue}t.add("})")}return t}resolveFor(e,r){let t=new y,s=e.attr.key,i=e.attr.item,o=e.attr.array,a=`_$node${r}`;t.add(`const ${a} = new _$.ForNode()`);let p=this.geneDeps(o);if(p.length>0){t.add(`${a}._$addNodeFunc((_$key, _$idx, node_for) => {`);let m=i.match(/[_$a-zA-Z][_$a-zA-Z0-9]*/g)??[];t.add(`const ${i} = node_for._$getItem(_$key, _$idx)`);let u=`_$valuedItem${N()}`;t.add(`const ${u} = {}`);for(let g of m)t.add(`${u}.${g} = ${g}`);t.add(`node_for._$listen(this, ()=>node_for._$getItem(_$key, _$idx),             ${b(p)}, (_$item) => {`),t.add(`const ${i} = _$item`);for(let g of m)t.add(`${u}.${g} = ${g}`);t.add("})");let v=new w(this.depChain,this.subViews,[...this.idDepsArr,{ids:G(i),propNames:p}]).generate(e.children);v=Q(v,i,u),t.add(v),t.add("})"),s&&(t.add(`${a}._$addKeyFunc(() => {`),t.add("const keys = []"),t.add(`for (let ${i} of ${o}) {`),t.add(`keys.push(${s})`),t.add("}"),t.add("return keys"),t.add("})")),t.add(`${a}._$addArrayFunc(this, () => (${o}), ${b(p)})`)}else t.add(`${a}._$addNodess(() => Array.from(${o}).map((${i}) => (() => {`),t.add(this.generate(e.children)),t.add("})()))");return t}resolveText(e,r){let t=new y,s=e.attr._$content,i=this.geneDeps(`${s}`),o=`_$node${r}`;return i.length>0?t.add(`const ${o} = new _$.TextNode(() => ${s}, this, ${b(i)})`):t.add(`const ${o} = new _$.TextNode(${s}, )`),t}resolveHTML(e,r){let t=new y,s=`_$node${r}`;t.add(`const ${s} = new _$.HtmlNode(${e.tag}, )`);for(let{key:i,value:o,nodes:a}of e.attr.props){if(o=this.parsePropNodes(o,a),i==="element"){t.add(`${o} = ${s}._$el`);continue}if(["willAppear","didAppear","willDisappear","didDisappear"].includes(i)){t.add(`${s}._$addLifeCycle(${o}, "${i}")`);continue}i==="_$content"&&(i="innerText");let p=this.geneDeps(o);if(p.length>0){t.add(`${s}._$addProp("${i}", () => (${o}), this, ${b(p)})`);continue}t.add(`${s}._$addProp("${i}", ${o})`)}return e.children.length>0&&(t.add(`${s}._$addNodes((() => {`),t.add(this.generate(e.children)),t.add("})())")),t}resolveCustom(e,r){let t=new y,s=`_$node${r}`;t.add(`const ${s} = new (${e.tag})()`);for(let{key:i,value:o,nodes:a}of e.attr.props){if(o=this.parsePropNodes(o,a),i==="element"){Y(o)?t.add(`${s}._$addAfterset(() => (${o})(${s}._$el))`):t.add(`${s}._$addAfterset(() => ${o} = ${s}._$el)`);continue}if(["willMount","didMount","willUnmount","didUnmount"].includes(i)){t.add(`${s}._$addLifeCycle(${o}, "${i}")`);continue}let p=this.geneDeps(o);if(p.length>0){t.add(`${s}._$addProp("${i}", () => (${o}), this, ${b(p)}, ${F(o)})`);continue}t.add(`${s}._$addProp("${i}", ${o})`)}return e.children.length>0&&(t.add(`${s}._$addChildren((() => {`),t.add(this.generate(e.children)),t.add("})())")),t}resolveSubView(e,r){e.attr.isSubView=!0;let t=new y,s=e.attr.props.map(({key:a,value:p,nodes:m})=>({key:a,value:this.parsePropNodes(p,m)})),i=N(),o=[];for(let{key:a,value:p}of s){let m=`${a}_${i}`,h=b(this.geneDeps(p));t.add(`const ${m} = {value: ${p}, deps: ${h}}`),t.add(`this._$addDeps(${h}, {}, () => {${m}.value = ${p}})`),o.push({key:a,keyWithId:m})}return t.add(`const _$node${r} = ${e.tag}({${o.map(({key:a,keyWithId:p})=>`${a}: ${p}`).join(", ")}})`),t}resolveEnv(e,r){let t=new y,s=`_$node${r}`;t.add(`const ${s} = new _$.EnvNode()`),e.children.length>0&&(t.add(`${s}._$addNodes((() => {`),t.add(this.generate(e.children)),t.add("})())"));for(let{key:i,value:o,nodes:a}of e.attr.props){o=this.parsePropNodes(o,a);let p=this.geneDeps(o);if(p.length>0){t.add(`${s}._$addProp("${i}", () => (${o}), this, ${b(p)}, ${F(o)})`);continue}t.add(`${s}._$addProp("${i}", ${o})`)}return t}resolveExpression(e,r){let t=new y,s=`_$node${r}`;for(let{key:i,value:o,nodes:a}of e.attr.props){if(o=this.parsePropNodes(o,a),i==="_$content"){let m=this.geneDeps(o);m.length>0?t.add(`const ${s} = new _$.ExpressionNode(() => ${o}, this, ${b(m)})`):t.add(`const ${s} = new _$.ExpressionNode(${o}, )`);continue}if(i==="onUpdateNodes"){t.add(`${s}._$onUpdateNodes(${o})`);continue}let p=this.geneDeps(o);if(p.length>0){t.add(`${s}._$addProp("${i}", () => (${o}), this, ${b(p)}, ${F(o)})`);continue}t.add(`${s}._$addProp("${i}", ${o})`)}return t}parsePropNodes(e,r){for(let[t,s]of Object.entries(r)){let i=new y;i.add("((()=>{"),i.add(this.generate(s)),i.add("})())"),e=e.replace('"'+t+'"',i.value)}return e}};function J(n,e,r,t=[]){return new w(e,r,t).generate(n)}var c=_(require("@babel/types"));function he(){return Math.random().toString(32).slice(2)}function ee(n,e){if(!e)return{key:n,value:!0,nodes:{}};let r=d.parse(`let _ = ${d.generate(e)}`),t={};return d.traverse(r,{DoExpression(s){let i=s.node,o=he();t[o]=re(i.body.body),s.replaceWith(c.stringLiteral(o))}}),{key:n,value:d.generate(r.program.body[0].declarations[0].init),nodes:t}}function be(n){let e={tag:"",attr:{props:[]},children:[]},r=n;for(;r&&r.callee?.object&&!c.isThisExpression(r.callee?.object);){let t=r.arguments[0],s=r.callee.property.name;e.attr.props.unshift(ee(s,t)),r=r.callee.object}return r.callee?.callee?.name==="tag"&&(r=c.callExpression(r.callee.arguments[0],[])),r.arguments.length>0&&e.attr.props.unshift(ee("_$content",r.arguments[0])),e.tag=d.generate(r.callee),e}function xe(n){return{tag:"_$text",attr:{_$content:d.generate(n)},children:[]}}function ve(n){let e=te(n.tag);Array.isArray(e)||(e=[e]);let r={tag:"_$text",attr:{_$content:d.generate(n.quasi)},children:[]};return[...e,r]}function te(n){return c.isCallExpression(n)?be(n):c.isStringLiteral(n)||c.isTemplateLiteral(n)?xe(n):c.isTaggedTemplateExpression(n)?ve(n):{}}function _e(n){let e=d.generate(n.left.declarations[0]),r=d.generate(n.right),t={tag:"for",attr:{item:e,array:r},children:[]},s=n.body.body;return c.isArrayExpression(s[0].expression)&&(t.attr.key=d.generate(s[0].expression.elements[0]),s=s.slice(1)),t.children=k(s),t}function Pe(n){return{tag:"if",attr:{conditions:ne(n)},children:[]}}function ne(n){let e=[],r=d.generate(n.test),t=k(n.consequent.body);return e.push({condition:r,parserNodes:t}),c.isIfStatement(n.alternate)?e.push(...ne(n.alternate)):n.alternate&&e.push({condition:!0,parserNodes:k(n.alternate.body)}),e}function k(n){let e=[];for(let r of n)if(c.isExpressionStatement(r)){let t=te(r.expression);Array.isArray(t)||(t=[t]),e.push(...t)}else c.isBlockStatement(r)?e[e.length-1].children=k(r.body):c.isForOfStatement(r)?e.push(_e(r)):c.isIfStatement(r)&&e.push(Pe(r));return e}function re(n){return k(n)}var L=re;var x=_(require("@babel/types"));function se(n,e){if(!e)return{key:n,value:!0,nodes:{}};let r=d.parse(d.generate(e)),t={};d.traverse(r,{JSXElement(i){let o=N();t[o]=P([i.node]),i.replaceWith(x.stringLiteral(o))}});let s=d.generate(e);return x.isJSXExpressionContainer(e)&&(s=s.replace(/^\{(.+)\}$/,"$1")),s.trim()===""&&(s='""'),{key:n,value:s,nodes:t}}function Ee(n){let e=n.openingElement.name.name,r=[];for(let t of n.openingElement.attributes)t=t,r.push(se(t.name.name,t.value));return{tag:e,attr:{props:r},children:P(n.children)}}function Se(n){let e=n.value.trim();return e===""?void 0:{tag:"_$text",attr:{_$content:`"${e}"`},children:[]}}function C(n,e){let r=n.openingElement.attributes.find(i=>i.name.name===e);if(!r)return r;let t="",s=r.value;return t=x.isJSXExpressionContainer(s)?d.generate(s.expression):d.generate(s),t}function Ne(n){return{tag:"if",attr:{conditions:[{condition:C(n,"cond"),parserNodes:P(n.children)}]},children:[]}}function we(n,e){e.attr.conditions.push({condition:C(n,"cond"),parserNodes:P(n.children)})}function ke(n,e){e.attr.conditions.push({condition:"true",parserNodes:P(n.children)})}function Ce(n){return{tag:"for",attr:{item:C(n,"let"),array:C(n,"of"),key:C(n,"key")},children:P(n.children)}}function Ie(n){return{tag:"_",attr:{props:[se("_$content",n)]},children:[]}}function P(n){let e=[];for(let r of n){if(x.isJSXText(r)){let s=Se(r);s&&e.push(s);continue}if(x.isJSXExpressionContainer(r)){e.push(Ie(r));continue}if(x.isJSXFragment(r)){e.push(...P(r.children));continue}let t=r.openingElement.name.name;if(t==="if"){e.push(Ne(r));continue}if(t==="else-if"){we(r,e[e.length-1]);continue}if(t==="else"){ke(r,e[e.length-1]);continue}if(t==="for"){e.push(Ce(r));continue}e.push(Ee(r))}return e}function De(n){return P([n])}var oe=De;var S=_(require("@babel/types"));function ie(n,e){let r=n.key.name;n.key.name=`_$$${r}`;let t=e.body.indexOf(n),s=E(`
    function ${r}() {
        return this._$$${r}
    }`),i=E(`
    function ${r}(value) {
        if (this._$$${r} === value) return
        this._$$${r} = value
        this._$runDeps("${r}")
    }`),[o,a]=z(r,s,i);e.body.splice(t+1,0,o,a)}function ae(n,e,r){let t=n.key.name,s=e.body.indexOf(n),i=r.toLowerCase(),o=S.classProperty(S.identifier(`_$$${t}`),S.stringLiteral(`_$${i}`));e.body.splice(s,0,o)}function Ae(n,e,r,t=!1){let s;if(t){let o=n.params[0].properties.map(a=>a.key.name).map(a=>({ids:[a],propNames:[`...${a}.deps`]}));s=J(L(n.body.body),e,r,o)}else s=J(L(n.body.body),e,r);n.body=E(`function tmp() { ${s} }`)}function Be(n,e,r){let t=J(oe(n.value),e,r);n.value=l.arrowFunctionExpression([],E(`function tmp() { ${t} }`))}function Fe(n){let e=n.params[0];if(!e||!l.isObjectPattern(e))return;let r=[];for(let s of e.properties){let i=s.key.name;r.push(i),l.isAssignmentPattern(s.value)&&(s.value.right=l.objectExpression([l.objectProperty(l.identifier("value"),s.value.right),l.objectProperty(l.identifier("deps"),l.arrayExpression())]))}let t=d.parse(`function tmp() ${d.generate(n.body)}`);d.traverse(t,{Identifier(s){r.includes(s.node.name)&&!l.isMemberExpression(s.parentPath.node)&&(s.replaceWith(l.memberExpression(l.identifier(s.node.name),l.identifier("value"))),s.skip())}}),n.body=t.program.body[0].body}function j(n,e,r){let t=r==="jsd"?Ae:Be,s,i=[];for(let a of n.body)a.decorators?.find(p=>l.isIdentifier(p.expression)&&p.expression.name==="View")?(a.decorators=void 0,i.push(a)):a.key.name==="Body"&&(s=a);let o=i.map(a=>"this."+a.key.name);for(let a of i)t(a,e,o,!0),Fe(a);t(s,e,o)}function de(n,e){let r=d.parse(n),t=null,s=null,i=null,o=null,a=[];return d.traverse(r,{ClassDeclaration(h){let u=h.node;if(l.isIdentifier(u.superClass,{name:"View"})){t=u,s=t.body,s.body.unshift(l.classProperty(l.identifier("_$tag"),l.stringLiteral(t.id.name))),o=l.classProperty(l.identifier("_$derivedPairs"),l.objectExpression([])),i=l.classProperty(l.identifier("_$deps"),l.objectExpression([])),a=[];return}},ClassMethod(h){!t||s.body.indexOf(h.node)===s.body.length-1&&j(s,a,e)},ClassProperty(h){if(!t)return;let u=h.node,T=s.body.indexOf(h.node)===s.body.length-1;if(u.decorators?.find(g=>l.isIdentifier(g.expression)&&g.expression.name==="View")||u.key.name==="Body"){T&&j(s,a,e);return}let v=[];if(h.scope.traverse(u,{MemberExpression(g){a.includes(g.node.property.name)&&B(g,t)&&v.push(g.node.property.name)}}),v=[...new Set(v)],v.length>0&&(O(u.key.name,v,o,s),A(u.key.name,i,s),H(u),a.push(u.key.name)),u.decorators){for(let g of u.decorators){let X=g.expression.name??g.expression.callee.name;if(["EnvState","PropState","State"].includes(X)){a.push(u.key.name),A(u.key.name,i,s),ie(u,s);break}if(["Prop","Env"].includes(X)){a.push(u.key.name),A(u.key.name,i,s),ae(u,s,X);break}}u.decorators=null}T&&j(s,a,e)}}),`import * as _$ from '@dlightjs/dlight';
`+d.generate(r)}0&&(module.exports={parseDlightFile});

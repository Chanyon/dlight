import*as c from"@babel/types";import*as A from"@babel/core";import ue from"@babel/generator";var d={traverse:A.traverse,generate:n=>ue(n).code,parse:n=>A.parse(n,{plugins:[["@babel/plugin-syntax-typescript",{isTSX:!0}],"@babel/plugin-syntax-jsx","@babel/plugin-syntax-do-expressions",["@babel/plugin-syntax-decorators",{legacy:!0}]]})};function W(n,e,s,t){t.body.includes(s)||t.body.unshift(s),s.value.properties.push(c.objectProperty(c.identifier(n),c.arrayExpression(e.map(r=>c.stringLiteral(r)))))}function T(n,e,s){s.body.includes(e)||s.body.unshift(e),!e.value.properties.map(t=>t.key.name).includes(n)&&e.value.properties.push(c.objectProperty(c.identifier(n),c.newExpression(c.identifier("Map"),[])))}function O(n,e){let s=!1,t=n.parentPath;for(;t&&t.node!==e;){if(c.isArrowFunctionExpression(t.node)){s=!0;break}t=t.parentPath}return s}function fe(n){let e=n.parentPath.node;return c.isAssignmentExpression(e)&&e.left===n.node}function ye(n,e){let s=n.node,t=!1,r=n.parentPath;for(;r&&r.node!==e;){if(c.isAssignmentExpression(r.node)){let i=r.node.left,o=s.type===i.type,a=s.property.name===i.property.name;t=o&&a}r=r.parentPath}return t}function B(n,e){return!O(n,e)&&!fe(n)&&!ye(n,e)}function E(n){return d.parse(n).program.body[0].body}function z(n,e,s){return[c.classMethod("get",c.identifier(n),[],e),c.classMethod("set",c.identifier(n),[c.identifier("value")],s)]}function K(n){let e=n.value;n.value={type:"ArrowFunctionExpression",params:[],body:e}}function H(n){return d.generate(n.expression)}function F(n,e){return c.isMemberExpression(n)&&!n.computed&&n.property===e}function J(n,e){return c.isObjectProperty(n)&&n.key===e}import*as p from"@babel/types";function R(n){let e=/html\((.+)\)/;return e.test(n.tag)?(n.tag=n.tag.replace(e,"$1"),!0):/^[a-z][a-z0-9]*$/.test(n.tag)?(n.tag=`"${n.tag}"`,!0):!1}function U(n){let e=/tag\((.+)\)/;e.test(n.tag)&&(n.tag=n.tag.replace(e,"$1"))}function q(n){return`${n}
`}function Z(n){return"["+n.map((e,s)=>e.attr.isSubView?`..._$node${s}`:`_$node${s}`).join(", ")+"]"}var $=class{value="";add(e){this.value+=q(e)}shift(e){this.value=q(e)+this.value}addBody(e){this.value+=e.value}};import*as h from"@babel/types";function b(n){return"["+n.map(e=>e.startsWith("...")?e:'"'+e+'"').join(", ")+"]"}function w(){return Math.random().toString(20).slice(2,8)}function G(n,e,s=[]){let t=d.parse(`(${n})`),r=[];return d.traverse(t,{MemberExpression(i){e.includes(i.node.property.name)&&B(i)&&r.push(i.node.property.name)}}),r=[...new Set([...r,...s])],r}function Q(n,e,s=[]){let t=d.parse(`(${n})`),r=[];return d.traverse(t,{Identifier(i){for(let{ids:o,propNames:a}of e)o.includes(i.node.name)&&(O(i)||r.push(...a))}}),r=[...new Set([...r,...s])],r}function Y(n){return n.match(/[_$a-zA-Z][_$a-zA-Z0-9]*/g)??[]}function X(n){let e=d.parse(`(${n})`);return h.isMemberExpression(e.program.body[0].expression)}function ee(n,e,s){let t=[],r=d.parse(e);d.traverse(r,{Identifier(o){t.push(o.node.name)}});let i=d.parse(`function tempFunc() {${n}}`);return d.traverse(i,{Identifier(o){if(t.includes(o.node.name)&&!F(o.parentPath.node,o.node)&&!J(o.parentPath.node,o.node)){let a=h.memberExpression(h.identifier(s),h.identifier(o.node.name));o.replaceWith(a),o.skip()}}}),d.generate(i.program.body[0].body).trim().replace(/(^\{)|(\}$)/g,"")}function te(n){let e=d.parse(`let _ = ${n}`).program.body[0].declarations[0].init;return!!(h.isArrowFunctionExpression(e)||h.isFunctionExpression(e))}var k=class{depChain;subViews;idDepsArr=[];constructor(e,s,t=[]){this.depChain=e,this.subViews=s,this.idDepsArr=t}generate(e){let s=new $;for(let[t,r]of e.entries())s.addBody(this.resolveParserNode(r,t));return s.add(`return ${Z(e)}`),s.value}geneDeps(e){return[...new Set([...G(e,this.depChain),...Q(e,this.idDepsArr)])]}resolveParserNode(e,s){return this.subViews.includes(e.tag)?this.resolveSubView(e,s):e.tag==="env"?this.resolveEnv(e,s):e.tag==="_"?this.resolveExpression(e,s):e.tag==="if"?this.resolveIf(e,s):e.tag==="for"?this.resolveFor(e,s):e.tag==="_$text"?this.resolveText(e,s):R(e)?this.resolveHTML(e,s):(U(e),this.resolveCustom(e,s))}resolveIf(e,s){let t=new $,r=`_$node${s}`;t.add(`const ${r} = new _$.IfNode()`);for(let i of e.attr.conditions){t.add(`${r}._$addCond(() => ${i.condition}, () => {`),t.add(this.generate(i.parserNodes));let o=this.geneDeps(i.condition);if(o.length>0){t.add(`}, this, ${b(o)})`);continue}t.add("})")}return t}resolveFor(e,s){let t=new $,r=e.attr.key,i=e.attr.item,o=e.attr.array,a=`_$node${s}`;t.add(`const ${a} = new _$.ForNode()`);let l=this.geneDeps(o);if(l.length>0){t.add(`${a}._$addNodeFunc((_$key, _$idx, node_for) => {`);let y=i.match(/[_$a-zA-Z][_$a-zA-Z0-9]*/g)??[];t.add(`const ${i} = node_for._$getItem(_$key, _$idx)`);let u=`_$valuedItem${w()}`;t.add(`const ${u} = {}`);for(let _ of y)t.add(`${u}.${_} = ${_}`);t.add(`node_for._$listen(this, ()=>node_for._$getItem(_$key, _$idx),             ${b(l)}, (_$item) => {`),t.add(`const ${i} = _$item`);for(let _ of y)t.add(`${u}.${_} = ${_}`);t.add("})");let S=new k(this.depChain,this.subViews,[...this.idDepsArr,{ids:Y(i),propNames:l}]).generate(e.children);S=ee(S,i,u),t.add(S),t.add("})"),r&&(t.add(`${a}._$addKeyFunc(() => {`),t.add("const keys = []"),t.add(`for (let ${i} of ${o}) {`),t.add(`keys.push(${r})`),t.add("}"),t.add("return keys"),t.add("})")),t.add(`${a}._$addArrayFunc(this, () => (${o}), ${b(l)})`)}else t.add(`${a}._$addNodess(() => Array.from(${o}).map((${i}) => (() => {`),t.add(this.generate(e.children)),t.add("})()))");return t}resolveText(e,s){let t=new $,r=e.attr._$content,i=this.geneDeps(`${r}`),o=`_$node${s}`;return i.length>0?t.add(`const ${o} = new _$.TextNode(() => ${r}, this, ${b(i)})`):t.add(`const ${o} = new _$.TextNode(${r}, )`),t}resolveHTML(e,s){let t=new $,r=`_$node${s}`;t.add(`const ${r} = new _$.HtmlNode(${e.tag}, )`);for(let{key:i,value:o,nodes:a}of e.attr.props){if(o=this.parsePropNodes(o,a),i==="element"){t.add(`${o} = ${r}._$el`);continue}if(["willAppear","didAppear","willDisappear","didDisappear"].includes(i)){t.add(`${r}._$addLifeCycle(${o}, "${i}")`);continue}i==="_$content"&&(i="innerText");let l=this.geneDeps(o);if(l.length>0){t.add(`${r}._$addProp("${i}", () => (${o}), this, ${b(l)})`);continue}t.add(`${r}._$addProp("${i}", ${o})`)}return e.children.length>0&&(t.add(`${r}._$addNodes((() => {`),t.add(this.generate(e.children)),t.add("})())")),t}resolveCustom(e,s){let t=new $,r=`_$node${s}`;t.add(`const ${r} = new (${e.tag})()`);for(let{key:i,value:o,nodes:a}of e.attr.props){if(o=this.parsePropNodes(o,a),i==="element"){te(o)?t.add(`${r}._$addAfterset(() => (${o})(${r}._$el))`):t.add(`${r}._$addAfterset(() => ${o} = ${r}._$el)`);continue}if(["willMount","didMount","willUnmount","didUnmount"].includes(i)){t.add(`${r}._$addLifeCycle(${o}, "${i}")`);continue}let l=this.geneDeps(o);if(l.length>0){t.add(`${r}._$addProp("${i}", () => (${o}), this, ${b(l)}, ${X(o)})`);continue}t.add(`${r}._$addProp("${i}", ${o})`)}return e.children.length>0&&(t.add(`${r}._$addChildren((() => {`),t.add(this.generate(e.children)),t.add("})())")),t}resolveSubView(e,s){e.attr.isSubView=!0;let t=new $,r=e.attr.props.map(({key:a,value:l,nodes:y})=>({key:a,value:this.parsePropNodes(l,y)})),i=w(),o=[];for(let{key:a,value:l}of r){let y=`${a}_${i}`,g=b(this.geneDeps(l));t.add(`const ${y} = {value: ${l}, deps: ${g}}`),t.add(`this._$addDeps(${g}, {}, () => {${y}.value = ${l}})`),o.push({key:a,keyWithId:y})}return t.add(`const _$node${s} = ${e.tag}({${o.map(({key:a,keyWithId:l})=>`${a}: ${l}`).join(", ")}})`),t}resolveEnv(e,s){let t=new $,r=`_$node${s}`;t.add(`const ${r} = new _$.EnvNode()`),e.children.length>0&&(t.add(`${r}._$addNodes((() => {`),t.add(this.generate(e.children)),t.add("})())"));for(let{key:i,value:o,nodes:a}of e.attr.props){o=this.parsePropNodes(o,a);let l=this.geneDeps(o);if(l.length>0){t.add(`${r}._$addProp("${i}", () => (${o}), this, ${b(l)}, ${X(o)})`);continue}t.add(`${r}._$addProp("${i}", ${o})`)}return t}resolveExpression(e,s){let t=new $,r=`_$node${s}`;for(let{key:i,value:o,nodes:a}of e.attr.props){if(o=this.parsePropNodes(o,a),i==="_$content"){let y=this.geneDeps(o);y.length>0?t.add(`const ${r} = new _$.ExpressionNode(() => ${o}, this, ${b(y)})`):t.add(`const ${r} = new _$.ExpressionNode(${o}, )`);continue}if(i==="onUpdateNodes"){t.add(`${r}._$onUpdateNodes(${o})`);continue}let l=this.geneDeps(o);if(l.length>0){t.add(`${r}._$addProp("${i}", () => (${o}), this, ${b(l)}, ${X(o)})`);continue}t.add(`${r}._$addProp("${i}", ${o})`)}return t}parsePropNodes(e,s){for(let[t,r]of Object.entries(s)){let i=new $;i.add("((()=>{"),i.add(this.generate(r)),i.add("})())"),e=e.replace('"'+t+'"',i.value)}return e}};function C(n,e,s,t=[]){return new k(e,s,t).generate(n)}import*as f from"@babel/types";function ge(){return Math.random().toString(32).slice(2)}function ne(n,e){if(!e)return{key:n,value:!0,nodes:{}};let s=d.parse(`let _ = ${d.generate(e)}`),t={};return d.traverse(s,{DoExpression(r){let i=r.node,o=ge();t[o]=oe(i.body.body),r.replaceWith(f.stringLiteral(o))}}),{key:n,value:d.generate(s.program.body[0].declarations[0].init),nodes:t}}function me(n){let e={tag:"",attr:{props:[]},children:[]},s=n;for(;s&&s.callee?.object&&!f.isThisExpression(s.callee?.object);){let t=s.arguments[0],r=s.callee.property.name;e.attr.props.unshift(ne(r,t)),s=s.callee.object}return s.arguments.length>0&&e.attr.props.unshift(ne("_$content",s.arguments[0])),e.tag=d.generate(s.callee),e}function $e(n){return{tag:"_$text",attr:{_$content:d.generate(n)},children:[]}}function he(n){let e=re(n.tag);Array.isArray(e)||(e=[e]);let s={tag:"_$text",attr:{_$content:d.generate(n.quasi)},children:[]};return[...e,s]}function re(n){return f.isCallExpression(n)?me(n):f.isStringLiteral(n)||f.isTemplateLiteral(n)?$e(n):f.isTaggedTemplateExpression(n)?he(n):{}}function be(n){let e=d.generate(n.left.declarations[0]),s=d.generate(n.right),t={tag:"for",attr:{item:e,array:s},children:[]},r=n.body.body;return f.isArrayExpression(r[0].expression)&&(t.attr.key=d.generate(r[0].expression.elements[0]),r=r.slice(1)),t.children=D(r),t}function xe(n){return{tag:"if",attr:{conditions:se(n)},children:[]}}function se(n){let e=[],s=d.generate(n.test),t=D(n.consequent.body);return e.push({condition:s,parserNodes:t}),f.isIfStatement(n.alternate)?e.push(...se(n.alternate)):n.alternate&&e.push({condition:!0,parserNodes:D(n.alternate.body)}),e}function D(n){let e=[];for(let s of n)if(f.isExpressionStatement(s)){let t=re(s.expression);Array.isArray(t)||(t=[t]),e.push(...t)}else f.isBlockStatement(s)?e[e.length-1].children=D(s.body):f.isForOfStatement(s)?e.push(be(s)):f.isIfStatement(s)&&e.push(xe(s));return e}function oe(n){return D(n)}var M=oe;import*as x from"@babel/types";function ie(n,e){if(!e)return{key:n,value:!0,nodes:{}};let s=d.parse(d.generate(e)),t={};d.traverse(s,{JSXElement(i){let o=w();t[o]=P([i.node]),i.replaceWith(x.stringLiteral(o))}});let r=d.generate(e);return x.isJSXExpressionContainer(e)&&(r=r.replace(/^\{(.+)\}$/,"$1")),r.trim()===""&&(r='""'),{key:n,value:r,nodes:t}}function ve(n){let e=n.openingElement.name.name,s=[];for(let t of n.openingElement.attributes)t=t,s.push(ie(t.name.name,t.value));return{tag:e,attr:{props:s},children:P(n.children)}}function _e(n){let e=n.value.trim();return e===""?void 0:{tag:"_$text",attr:{_$content:`"${e}"`},children:[]}}function I(n,e){let s=n.openingElement.attributes.find(i=>i.name.name===e);if(!s)return s;let t="",r=s.value;return t=x.isJSXExpressionContainer(r)?d.generate(r.expression):d.generate(r),t}function Pe(n){return{tag:"if",attr:{conditions:[{condition:I(n,"cond"),parserNodes:P(n.children)}]},children:[]}}function Ee(n,e){e.attr.conditions.push({condition:I(n,"cond"),parserNodes:P(n.children)})}function Se(n,e){e.attr.conditions.push({condition:"true",parserNodes:P(n.children)})}function Ne(n){return{tag:"for",attr:{item:I(n,"let"),array:I(n,"of"),key:I(n,"key")},children:P(n.children)}}function we(n){return{tag:"_",attr:{props:[ie("_$content",n)]},children:[]}}function P(n){let e=[];for(let s of n){if(x.isJSXText(s)){let r=_e(s);r&&e.push(r);continue}if(x.isJSXExpressionContainer(s)){e.push(we(s));continue}if(x.isJSXFragment(s)){e.push(...P(s.children));continue}let t=s.openingElement.name.name;if(t==="if"){e.push(Pe(s));continue}if(t==="else-if"){Ee(s,e[e.length-1]);continue}if(t==="else"){Se(s,e[e.length-1]);continue}if(t==="for"){e.push(Ne(s));continue}e.push(ve(s))}return e}function ke(n){return P([n])}var ae=ke;import*as v from"@babel/types";function de(n,e,s){let t=n.key.name;n.key.name=`_$$${t}`;let r=e.body.indexOf(n),i=s.map(g=>`if (${g}.preset) value = ${g}.preset(value, d=>this.${t}=d)`).join(`
`),o=E(`
    function ${t}() {
        return this._$$${t}
    }`),a=E(`
    function ${t}(value) {
        ${i}
        if (this._$$${t} === value) return
        this._$$${t} = value
        this._$runDeps("${t}")
    }`),[l,y]=z(t,o,a);e.body.splice(r+1,0,l,y)}function pe(n,e,s){let t=n.key.name,r=e.body.indexOf(n),i=s.toLowerCase(),o=v.classProperty(v.identifier(`_$$${t}`),v.stringLiteral(`_$${i}`));e.body.splice(r,0,o)}function le(n,e,s){let t=n.key.name,r=d.generate(n.value??v.identifier("undefined"));if(!/^[0-9a-zA-z$_]+$/.test(e)){let i=s.body.indexOf(n),o=e.match(/^[0-9a-zA-z$_]+/)[0];s.body.splice(i,0,v.classProperty(v.identifier(`_$$${t}_${o}`),d.parse(e).program.body[0].expression)),e=`this._$$${t}_${o}`}return n.value=d.parse(`(${e}.func??(typeof ${e} === "function" ? ${e} : (_=>_)))(${r}, (_)=>this.${n.key.name}=_)`).program.body[0].expression,e}function Ce(n,e,s,t=!1){let r;if(t){let i=n.params[0];if(!i||!p.isObjectPattern(i))r=C(M(n.body.body),e,s);else{let a=i.properties.map(l=>l.key.name).map(l=>({ids:[l],propNames:[`...${l}.deps`]}));r=C(M(n.body.body),e,s,a)}}else r=C(M(n.body.body),e,s);n.body=E(`function tmp() { ${r} }`)}function De(n,e,s){let t=C(ae(n.value),e,s);n.value=p.arrowFunctionExpression([],E(`function tmp() { ${t} }`))}function Ie(n){let e=n.params[0];if(!e||!p.isObjectPattern(e))return;let s=[];for(let r of e.properties){let i=r.key.name;s.push(i),p.isAssignmentPattern(r.value)&&(r.value.right=p.objectExpression([p.objectProperty(p.identifier("value"),r.value.right),p.objectProperty(p.identifier("deps"),p.arrayExpression())]))}let t=d.parse(`function tmp() ${d.generate(n.body)}`);d.traverse(t,{Identifier(r){s.includes(r.node.name)&&!F(r.parentPath.node,r.node)&&!J(r.parentPath.node,r.node)&&(r.replaceWith(p.memberExpression(p.identifier(r.node.name),p.identifier("value"))),r.skip())}}),n.body=t.program.body[0].body}function V(n,e,s){let t=s==="jsd"?Ce:De,r,i=[];for(let a of n.body)a.decorators?.find(l=>p.isIdentifier(l.expression)&&l.expression.name==="View")?(a.decorators=void 0,i.push(a)):a.key.name==="Body"&&(r=a);let o=i.map(a=>"this."+a.key.name);for(let a of i)Ie(a),t(a,e,o,!0);t(r,e,o)}function Ae(n,e){let s=d.parse(n),t=null,r=null,i=null,o=null,a=[];return d.traverse(s,{ClassDeclaration(g){let u=g.node;if(p.isIdentifier(u.superClass,{name:"View"})){t=u,r=t.body,r.body.unshift(p.classProperty(p.identifier("_$tag"),p.stringLiteral(t.id.name))),o=p.classProperty(p.identifier("_$derivedPairs"),p.objectExpression([])),i=p.classProperty(p.identifier("_$deps"),p.objectExpression([])),a=[];return}},ClassMethod(g){!t||r.body.indexOf(g.node)===r.body.length-1&&V(r,a,e)},ClassProperty(g){if(!t)return;let u=g.node,L=r.body.indexOf(g.node)===r.body.length-1;if(u.decorators?.find(m=>p.isIdentifier(m.expression)&&m.expression.name==="View")||u.key.name==="Body"){L&&V(r,a,e);return}let S=["EnvState","PropState","State","Prop","Env"],_=[],ce=(u.decorators??[]).map(m=>{let j=H(m);if(S.includes(j))return j;_.push(le(u,j,r))}).filter(m=>m),N=[];g.scope.traverse(u,{MemberExpression(m){a.includes(m.node.property.name)&&B(m,t)&&N.push(m.node.property.name)}}),N=[...new Set(N)],N.length>0&&(W(u.key.name,N,o,r),T(u.key.name,i,r),K(u),a.push(u.key.name));for(let m of ce){if(["EnvState","PropState","State"].includes(m)){a.push(u.key.name),T(u.key.name,i,r),de(u,r,_);break}if(["Prop","Env"].includes(m)){a.push(u.key.name),T(u.key.name,i,r),pe(u,r,m);break}}u.decorators=null,L&&V(r,a,e)}}),`import * as _$ from '@dlightjs/dlight';
`+d.generate(s)}export{Ae as parseDlightFile};
